var PersonalInfoModel=function(data,parent){var self=this;var environ=window.location.host;self.parent=parent;self.first_name=ko.observable("");self.last_name=ko.observable("");self.address=ko.observable("");self.email_address=ko.observable("");self.mobile_number=ko.observable("");self.student_number=ko.observable(parent.student_number());self.isEditing=ko.observable(false);self.old_data={};function getRequiredFields(){var required_fields={first_name:self.first_name(),last_name:self.last_name(),address:self.address(),email_address:self.email_address(),mobile_number:self.mobile_number()}
return required_fields;}
self.validateFields=function(){var prop=getRequiredFields();var failed=0;for(var i in prop){$field=$("#personal-information").find('input[name~="'+i+'"], textarea[name~="'+i+'"]');if($field.length==0)
window.location.reload();else{if(!self.parent.validate($field))
failed+=1;}}
if(failed==0){return prop;}else{self.parent.showPersonalInfo();self.edit();return false;}}
self.edit=function(){self.setOldData();self.isEditing(true);self.parent.isEditing(true);}
self.hasNoChanges=function(){for(var i in self.old_data){if(!(self.old_data[i]===self[i]())){return false;}}
return true;}
self.setOldData=function(){self.old_data=getRequiredFields();}
self.cancel=function(){self.isEditing(false);self.parent.isEditing(false);self.closeInfo();}
self.closeInfo=function(){$personalinfo=$('#personal-information .data-group');$personalinfo.find('div.div-loading').remove();$mask=$personalinfo.find('.alert-mask');$alert=$personalinfo.find(".alert-notify");$mask.removeClass("alert-notify");$alert.removeClass("alert-notify");}
self.save=function(item,event){var required_fields=self.validateFields();if(!required_fields){self.isEditing(false);self.parent.isEditing(false);self.closeInfo();return false;}
if(self.hasNoChanges()){self.isEditing(false);self.parent.isEditing(false);self.closeInfo();}else{var $target=$(event.target);var $personalinfo=$target.parents('div.data-group');data={data:required_fields,student_number:self.student_number(),section:"personal_information"}
if(environ==="localhost"){var baseurl=window.location.protocol+"//"+window.location.host+"/"+"resumebox/resume_editor/save_personal_information/";}else{var baseurl=window.location.protocol+"//"+window.location.host+"/"+"resume_editor/save_personal_information/";}
$.ajax({url:baseurl,type:"POST",data:data,beforeSend:function(){$('body').append('<div class="div-loading"></div>');},success:function(response){if(response){var response=JSON.parse(response);if(response['code']==1){$(".div-loading").remove();}else{window.location.replace(response['url']);}
self.cancel();}},error:function(x,t,h){if(t==="timeout"){self.setAlerts(".alert-error.alert-info");}},timeout:60000});}}
self.setAlerts=function(_class){$personalinfo=$('#personal-information .data-group');$personalinfo.find('div.div-loading').remove();$mask=$personalinfo.find('.alert-mask');$alert=$personalinfo.find(_class);$mask.addClass("alert-notify");$alert.addClass("alert-notify");setTimeout(function(){$mask.removeClass("alert-notify");$alert.removeClass("alert-notify");},2500);$mask.on('click',function(){$mask.removeClass('alert-notify');$alert.removeClass('alert-notify');});}
ko.mapping.fromJS(data,{},self);}
var EducationModel=function(data,parent){var self=this;var environ=window.location.host;self.parent=parent;self.type=ko.observable("");self.graduation_month=ko.observable("");self.gradution_year=ko.observable("");self.school_name=ko.observable("");self.degree_program=ko.observable("");self.recognitions=ko.observableArray([]);self.old_recognitions=ko.observableArray([]);self.to_delete_recognitions=[];self.isEditing=ko.observable(false);self.old_data=0;self.showSchool=ko.computed(function(){if(self.type()==="highschool")
return true;if(self.parent.student_type()==="Undergraduate"&&self.type()==="undergraduate")
return false;if(self.parent.student_type()==="Graduate"&&self.type()==="undergraduate"){self.school_name("");return true;}
if(self.parent.student_type()==="Graduate"&&self.type()==="graduate")
return false;},self);self.removeEmptyNewRecognitions=function(){ko.utils.arrayForEach(self.recognitions(),function(item){var str="";if(item.award_id()==0){if(str===item.award())
item.remove();}});}
self.hasNoChanges=function(){for(var prop in self.old_data){var a=self.old_data[prop];var b=self[prop]();var match=a===b;if(!match)
return false;}
if(self.old_recognitions().length!=self.recognitions().length)
return false;else{var bool=true;ko.utils.arrayForEach(self.recognitions(),function(item,index){var str=self.old_recognitions()[index].award();if(!(str===item.award())){bool=false;return false;}});return bool;}
return true;}
self.allowAddRecognition=function(){if(self.recognitions().length<10){return true;}
return false;}
self.addRecognition=function(){self.recognitions.push(new RecognitionModel({award_id:0},self));$('[data-toggle="tooltip"]').tooltip();}
self.getMainFields=function(){var required={graduation_month:self.graduation_month(),graduation_year:self.graduation_year()}
if(self.showSchool()){required['school_name']=self.school_name();}
if(self.type()!="highschool"){required['degree_program']=self.degree_program();}
return required;}
self.getMutatedMainFields=function(){var data={};for(var prop in self.getMainFields()){var a=self.old_data[prop];var b=self[prop]();var match=a===b;if(!match){data[prop]=b;}}
return data;}
self.validateFields=function($target){var required={graduation_month:self.graduation_month(),graduation_year:self.graduation_year()}
if(self.showSchool()){$.extend(required,{school_name:self.school_name()});}
if(self.type()!="highschool"){$.extend(required,{degree_program:self.degree_program()});}
var $education=$target.parents('div.education-group');var failed=0;for(var prop in required){$field=$education.find("input[name*='"+prop+"']");if($field.length==0)
$field=$education.find("select[name*='"+prop+"']");if($field.length==0)
$field=$education.find("textarea[name*='"+prop+"']");if($field.length==0){console.dir(prop);}else{if(!self.parent.validate($field,1))
failed+=1;}};return failed;}
self.validate=function(index){$target=$("div#education");var required={graduation_month:self.graduation_month(),graduation_year:self.graduation_year()}
if(self.showSchool()){$.extend(required,{school_name:self.school_name()});}
if(self.type()!="highschool"){$.extend(required,{degree_program:self.degree_program()});}
var $education=$target.find('div.education-group:eq('+index+')');var failed=0;for(var prop in required){$field=$education.find("input[name*='"+prop+"']");if($field.length==0)
$field=$education.find("select[name*='"+prop+"']");if($field.length==0)
$field=$education.find("textarea[name*='"+prop+"']");if($field.length==0){console.dir(prop);}else{if(!self.parent.validate($field,1))
failed+=1;}};if(failed){if(!self.isEditing()){self.edit(self);}}
return failed;}
self.save=function(item,event){self.closeInfo();if(!self.isEditing())
return;self.removeEmptyNewRecognitions();$target=$(event.target);var $education=$target.parents('div.education-group');var failed=self.validateFields($target);if(failed)
return false;if(item.hasNoChanges()){self.isEditing(false);self.parent.isEditing(false);return;}
if(!failed){var data;data={section:"education",type:self.type(),student_number:self.parent.student_number(),data:self.getMutatedMainFields(),recognitions:self.getRecognitions(),delete_recognitions:self.to_delete_recognitions};if(environ==="localhost"){var baseurl=window.location.protocol+"//"+window.location.host+"/"+"resumebox/resume_editor/save_education/";}else{var baseurl=window.location.protocol+"//"+window.location.host+"/"+"resume_editor/save_education/";}
$.ajax({url:baseurl,type:"POST",data:data,beforeSend:function(){$('body').append('<div class="div-loading"></div>');},success:function(response){if(response){response=JSON.parse(response);if(response['code']==404){console.dir(response);}
if(response['recognitions'].length>0){ko.utils.arrayForEach(self.recognitions(),function(item,index){if(!item.award_id()){item.award_id(response['recognitions'][index]);}});}
$('div.div-loading').remove();$education.find('.alert-mask').removeClass(".alert-notify");$education.find('.alert-info').removeClass(".alert-notify");self.isEditing(false);self.parent.isEditing(false);}},error:function(x,t,h){$('div.div-loading').remove();setTimeout(function(){$education.find('.alert-mask').addClass("alert-notify");$education.find('.alert-error').addClass("alert-notify");},300);$education.find('.alert-mask').on('click',function(){$education.find('.alert-mask').removeClass('alert-notify');$education.find('.alert-error').removeClass('alert-notify');});},timeout:120000});}}
self.closeInfo=function(){$('.alert-mask:visible').removeClass('alert-notify');$('.alert-info:visible').first().removeClass('alert-notify');$('.alert-error:visible').first().removeClass('alert-notify');}
self.getRecognitions=function(){var data=[];ko.utils.arrayForEach(self.recognitions(),function(item){var str="";if(!(str===item.award()))
data.push({award_id:item.award_id(),award:item.award()});else
item.remove();});return data;}
self.edit=function(item,event){self.isEditing(true);self.parent.isEditing(true);self.old_data=self.getMainFields();self.old_recognitions([]);self.to_delete_recognitions=[];ko.utils.arrayForEach(self.recognitions(),function(a){var b={};b.award_id=a.award_id();b.award=a.award();self.old_recognitions.push(new RecognitionModel(b,self));});if(event!=undefined){editor.scroll();editor.scrollTo($(event.target).parents('div.education-group'));}}
self.cancel=function(item,event){self.closeInfo();self.isEditing(false);self.parent.isEditing(false);for(var prop in self.old_data){self[prop](self.old_data[prop]);}
self.recognitions([]);ko.utils.arrayForEach(self.old_recognitions(),function(a){var b={};b.award_id=a.award_id;b.award=a.award;self.recognitions.push(new RecognitionModel(b,self));});self.to_delete_recognitions=[];self.old_recognitions([]);self.old_data=0;}
ko.mapping.fromJS(data,mapping,self);}
var RecognitionModel=function(data,parent){var self=this;self.parent=parent;self.award_id=ko.observable("");self.award=ko.observable("");self.remove=function(item){if(self.award_id())
self.parent.to_delete_recognitions.push(self.award_id());item.parent.recognitions.remove(item);}
ko.mapping.fromJS(data,mapping,self);}
var WorkExpModel=function(data,parent){var self=this;var environ=window.location.host;self.parent=parent;self.work_id=ko.observable("");self.from_date=ko.observable("");self.from_month=ko.observable("");self.from_year=ko.observable("");self.to_month=ko.observable("");self.to_year=ko.observable("");self.position=ko.observable("");self.company_name=ko.observable("");self.company_location=ko.observable("");self.work_descriptions=ko.observableArray([]);self.old_work_descriptions=[];self.to_delete_work_descriptions=ko.observableArray([]);self.isEditing=ko.observable(false);self.old_data=0;self.isEmpty=function(item){var notempty=0;if(self.work_id()==0){var str="";if(!str.match(self.from_month()))
notempty+=1;if(!str.match(self.from_year()))
notempty+=1;if(!str.match(self.to_month()))
notempty+=1;if(!str.match(self.to_year()))
notempty+=1;if(!str.match(self.company_name()))
notempty+=1;if(!str.match(self.company_location()))
notempty+=1;if(!str.match(self.position()))
notempty+=1;ko.utils.arrayForEach(self.work_descriptions(),function(x){if(!str.match(x.work_description())){notempty+=1;}});return notempty==0;}
return false;}
self.hasNoChanges=function(){for(var prop in self.old_data){var a=self.old_data[prop];var b=self[prop]();var match=a===b;if(!match)
return false;}
if(self.old_work_descriptions.length!=self.work_descriptions().length)
return false;else{var bool=true;ko.utils.arrayForEach(self.work_descriptions(),function(item,index){var str=self.old_work_descriptions[index].work_description;var match=str===item.work_description();if(!match){bool=false;return false;}});return bool;}
return true;}
self.allowAddWorkDescription=function(){if(self.work_description().length<7){return true;}
return false;}
self.addWorkDescription=function(){self.work_descriptions.push(new WorkDescriptionModel({work_description_id:0},self));$('[data-toggle="tooltip"]').tooltip();}
self.remove=function(item,event){$target=$(event.target);self.closeInfo();var $work=$target.parents('div.work-experience-group');if(environ==="localhost"){var baseurl=window.location.protocol+"//"+window.location.host+"/"+"resumebox/resume_editor/delete_work_experience/";}else{var baseurl=window.location.protocol+"//"+window.location.host+"/"+"resume_editor/delete_work_experience/";}
if(self.work_id()){$.ajax({url:baseurl,type:"POST",data:{section:"work_experience",student_number:self.parent.student_number(),work_id:self.work_id()},beforeSend:function(){$('body').append('<div class="div-loading"></div>');},success:function(response){if(response){response=JSON.parse(response);if(response['code']==1||response['code']==0){self.parent.workExp.remove(self);self.parent.isEditing(false);}else{window.location.replace(response['url']);}}},complete:function(){setTimeout(function(){$('div.div-loading').remove();self.isEditing(false);self.parent.isEditing(false);},800);}});}else{self.parent.workExp.remove(self);self.parent.isEditing(false);}}
self.getMainFields=function(){var maindata={from_month:self.from_month(),from_year:self.from_year(),to_month:self.to_month(),to_year:self.to_year(),company_name:self.company_name(),position:self.position(),company_location:self.company_location()}
return maindata;}
self.getMutatedMainFields=function(){if(!self.work_id()){return self.getMainFields();}else{var data={};for(var prop in self.old_data){var a=self.old_data[prop];var b=self[prop]();var match=a===b;if(!match){data[prop]=b;}}
return data;}}
self.getWorkDescriptions=function(){var data=[];ko.utils.arrayForEach(self.work_descriptions(),function(item){var str="";if(item!==undefined)
if(!(str===item.work_description()))
data.push({work_description_id:item.work_description_id(),work_description:item.work_description()});else
item.remove();});return data;}
self.getToDeleteWorkDescriptions=function(){var data=[];ko.utils.arrayForEach(self.to_delete_work_descriptions(),function(item){data.push({work_description_id:item.work_description_id()});});return data;}
self.save=function(item,event){self.closeInfo();if(!self.isEditing())
return;var work_descriptions=[];var delete_work_descriptions=self.getToDeleteWorkDescriptions();if(item.hasNoChanges()&&item.work_id()){self.isEditing(false);self.parent.isEditing(false);return;}
$target=$(event.target);var required={from_month:self.from_month(),from_year:self.from_year(),to_month:self.to_month(),to_year:self.to_year(),company_name:self.company_name(),position:self.position(),company_location:self.company_location()}
var $work=$target.parents('div.work-experience-group');var failed=0;for(var prop in required){$field=$work.find("input[name*='"+prop+"']");if($field.length==0)
$field=$work.find("select[name*='"+prop+"']");if($field.length==0)
$field=$work.find("textarea[name*='"+prop+"']");if($field.length==0){window.location.reload();}else{if(!self.parent.validate($field,1))
failed+=1;}};$work.find("input[name*='work_description']").each(function(){if(!self.parent.validate($(this),1))
failed+=1;})
if(!failed){var data;data={section:"work_experience",work_id:self.work_id(),student_number:self.parent.student_number(),data:jQuery.extend({student_number:self.parent.student_number()},self.getMutatedMainFields()),work_descriptions:self.getWorkDescriptions(),delete_work_descriptions:delete_work_descriptions};if(environ==="localhost"){var baseurl=window.location.protocol+"//"+window.location.host+"/"+"resumebox/resume_editor/save_work_experience/";}else{var baseurl=window.location.protocol+"//"+window.location.host+"/"+"resume_editor/save_work_experience/";}
$.ajax({url:baseurl,type:"POST",data:data,beforeSend:function(){$('body').append('<div class="div-loading"></div>');},success:function(response){if(response){response=JSON.parse(response);if(response['code']==404){window.location.replace(response['url']);}
if(!self.work_id()){self.work_id(response['work_id']);}
if(response['from_date']!=undefined){self.from_date(response['from_date']);}
if(response['work_descriptions'].length>0){ko.utils.arrayForEach(self.work_descriptions(),function(item,index){if(!item.work_description_id()){item.work_description_id(response['work_descriptions'][index]);}});}
self.parent.workExp().sort(function(l,r){if(l.from_date()!=r.from_date())
return l.from_date()<r.from_date()?1:-1;else
return l.work_id()>r.work_id()?1:-1;});self.parent.workExp.valueHasMutated();$('div.div-loading').remove();$work.find('.alert-mask').removeClass(".alert-notify");$work.find('.alert-info').removeClass(".alert-notify");self.isEditing(false);self.parent.isEditing(false);}},error:function(x,t,h){$work.find('div.div-loading').remove();$mask=$work.find('.alert-mask');$alert=$work.find('.alert-error');editor.scroll();editor.scrollTo($alert);setTimeout(function(){$mask.addClass("alert-notify");$alert.addClass("alert-notify");},300);$work.find('.alert-mask').on('click',function(){$work.find('.alert-mask').removeClass('alert-notify');$work.find('.alert-error').removeClass('alert-notify');});}});}}
self.closeInfo=function(){var index=self.parent.workExp.indexOf(self);var $mask=$('#workexp .alert-mask:eq('+index+')');var $alert=$('#workexp .alert-info:eq('+index+')');$('.alert-mask:visible').removeClass('alert-notify');$('.alert-info:visible').first().removeClass('alert-notify');$('.alert-error:visible').first().removeClass('alert-notify');}
self.edit=function(item,event){self.isEditing(true);self.parent.isEditing(true);self.old_data=self.getMainFields();self.old_work_descriptions=[];ko.utils.arrayForEach(self.work_descriptions(),function(a){var b={};b.work_description_id=a.work_description_id();b.work_description=a.work_description();self.old_work_descriptions.push(b);});if(event!=undefined){editor.scroll();editor.scrollTo($(event.target).parents('div.work-experience-group'));}}
self.cancel=function(item,event){item.closeInfo();if(item.work_id()==0){item.parent.workExp.remove(item);item.parent.isEditing(false);item.old_data=0;}else{item.isEditing(false);item.parent.isEditing(false);for(var prop in item.old_data){item[prop](item.old_data[prop]);}
self.work_descriptions([]);for(var i=0;i<self.old_work_descriptions.length;i+=1){var b={};b.work_description_id=self.old_work_descriptions[i].work_description_id;b.work_description=self.old_work_descriptions[i].work_description;self.work_descriptions.push(new WorkDescriptionModel(b,self));}
self.to_delete_work_descriptions([]);self.old_work_descriptions=[];self.old_data=0;}}
ko.mapping.fromJS(data,mapping,self);}
var WorkDescriptionModel=function(data,parent){var self=this;self.work_description_id=ko.observable("");self.parent=parent;self.work_description=ko.observable("");self.remove=function(){if(self.work_description_id())
self.parent.to_delete_work_descriptions.push(self);self.parent.work_descriptions.remove(self);}
ko.mapping.fromJS(data,mapping,self);}
var AffiliationModel=function(data,parent){var environ=window.location.host;var self=this;self.parent=parent;self.affiliation_id=ko.observable("");self.affiliation_name=ko.observable("");self.committees=ko.observableArray([new CommitteeModel({committee_id:0},self)]);self.isEditing=ko.observable("");self.old_data=[];self.old_committees=[];self.to_delete_committees=[];self.row_span=ko.computed(function(){return self.committees().length+1;},self);self.removeCommittee=function(item){var count=self.committees().length;if(count>1){self.committees.remove(item);}}
self.removeEmptyNewCommittees=function(event){ko.utils.arrayForEach(self.committees(),function(x,index){var y=ko.toJS(x);var required={committee_name:y.committee_name,from_month:y.from_month,from_year:y.from_year,to_month:y.to_month,to_year:y.to_year,task_description:y.task_description}
var filled=0;for(var prop in required){var a="";var b=required[prop];var match=a===b||b==undefined;if(!match){filled+=1;}}
if(!filled&&self.committees().length>1){if(!x.committee_id()){self.committees.remove(x);}}});}
self.addCommittee=function(item,event){var count=self.committees().length;if(count<10){self.committees.push(new CommitteeModel({committee_id:0},self));$target=$(event.target);$aff=$target.parents('.affiliation-group');$committee=$aff.find('.committee-group').last();var offsetToScroll=editor[0].scrollHeight-$committee.offset().top+$committee.height();editor.scroll();editor.scrollTo($committee);}}
self.save=function(item,event){if(!self.isEditing())
return;if(self.hasNoChanges()){self.isEditing(false);self.parent.isEditing(false);return;}
$target=$(event.target);var $affiliation=$target.parents('div.affiliation-group');var failed=0;var required={affiliation_name:item.affiliation_name()}
for(var prop in required){$field=$affiliation.find("input[name*='"+prop+"']");if($field.length==0)
$field=$affiliation.find("select[name*='"+prop+"']");if($field.length==0)
$field=$affiliation.find("textarea[name*='"+prop+"']");if($field.length==0){window.location.reload();}else{if(!self.parent.validate($field,1))
failed+=1;}};ko.utils.arrayForEach(self.committees(),function(committee,index){failed+=committee.validate($affiliation,index);});if(!failed){var data;if(environ==="localhost"){var baseurl=window.location.protocol+"//"+window.location.host+"/"+"resumebox/resume_editor/save_affiliation/";}else{var baseurl=window.location.protocol+"//"+window.location.host+"/"+"resume_editor/save_affiliation/";}
data={section:"affiliation",affiliation_id:self.affiliation_id(),student_number:self.parent.student_number(),data:{affiliation_name:self.affiliation_name(),order:self.order(),student_number:self.parent.student_number()},committees:self.getCommittees(),delete_committees:self.to_delete_committees};$.ajax({url:baseurl,type:"POST",data:data,beforeSend:function(){$('body').append('<div class="div-loading"></div>');},success:function(response){if(response){response=JSON.parse(response);if(response['code']==404){window.location.replace(response['url']);}
if(!self.affiliation_id()){self.affiliation_id(response['affiliation_id']);}
if(response['from_date']!=undefined){self.from_date(response['from_date']);}
if(response['committees']!=undefined)
if(response['committees'].length>0){ko.utils.arrayForEach(self.committees(),function(item,index){if(!item.committee_id()){item.committee_id(response['committees'][index]['committee_id']);item.from_date(response['committees'][index]['from_date'])}
var from_date=response['committees'][index]['from_date'];if(from_date!=undefined&&from_date!=""){item.from_date(from_date);}});}
self.committees().sort(function(l,r){if(l.from_date()!=r.from_date())
return l.from_date()<r.from_date()?1:-1;else
return l.committee_id()>r.committee_id()?1:-1;});self.committees.valueHasMutated();$('div.div-loading').remove();$affiliation.find('.alert-mask').removeClass(".alert-notify");$affiliation.find('.alert-info').removeClass(".alert-notify");self.isEditing(false);self.parent.isEditing(false);}},error:function(x,t,h){$('div.div-loading').remove();$mask=$affiliation.find('.alert-mask');$alert=$affiliation.find('.alert-error');editor.scroll();editor.scrollTo($affiliation.find('.work-actions'));setTimeout(function(){$affiliation.find('.alert-mask').addClass("alert-notify");$affiliation.find('.alert-error').addClass("alert-notify");},300);$affiliation.find('.alert-mask').on('click',function(){$affiliation.find('.alert-mask').removeClass('alert-notify');$affiliation.find('.alert-error').removeClass('alert-notify');});},timeout:120000});}}
self.remove=function(item,event){$target=$(event.target);var $affiliation=$target.parents('div.affiliation-group');var data;if(environ==="localhost"){var baseurl=window.location.protocol+"//"+window.location.host+"/"+"resumebox/resume_editor/delete_affiliation/";}else{var baseurl=window.location.protocol+"//"+window.location.host+"/"+"resume_editor/delete_affiliation/";}
if(self.affiliation_id()){$.ajax({url:baseurl,type:"POST",data:{section:"affiliation",student_number:self.parent.student_number(),affiliation_id:self.affiliation_id()},beforeSend:function(){$('body').append('<div class="div-loading"></div>');},success:function(response){if(response){response=JSON.parse(response);if(response['code']==1||response['code']==0){self.parent.affiliations.remove(self);self.parent.isEditing(false);}else{window.location.replace(response['url']);}}},complete:function(){setTimeout(function(){$('div.div-loading').remove();self.isEditing(false);self.parent.isEditing(false);},800);}});}else{self.parent.affiliations.remove(self);self.parent.isEditing(false);}}
self.edit=function(item,event){self.isEditing(true);self.parent.isEditing(true);self.old_data=[];self.to_delete_committees=[];self.old_data['affiliation_name']=self.affiliation_name();self.old_committees=[];ko.utils.arrayForEach(self.committees(),function(a){var b=a.getMainFields();b.committee_id=a.committee_id();self.old_committees.push(b);});if(event!=undefined){var offsetToScroll=$(event.target).parents('div.affiliation-group').offset().top;editor.scroll();editor.animate({scrollTop:offsetToScroll-200},"");}}
self.cancel=function(item,event){if(item.affiliation_id()==0){item.parent.affiliations.remove(item);item.parent.isEditing(false);item.old_data=0;}else{item.isEditing(false);item.parent.isEditing(false);for(var prop in item.old_data){item[prop](item.old_data[prop]);}
self.to_delete_committees=[];self.committees([]);for(var i=0;i<self.old_committees.length;i+=1){var b=self.old_committees[i];self.committees.push(new CommitteeModel(b,self));}}}
self.getCommittees=function(){var committees=[];ko.utils.arrayForEach(self.committees(),function(item){var data={};var committee={};committee['committee_id']=item.committee_id();data['committee_name']=item.committee_name();data['from_month']=item.from_month();data['from_year']=item.from_year();data['to_month']=item.to_present()?"":item.to_month();data['to_year']=item.to_present()?"":item.to_year();data['to_present']=item.to_present()?1:0;data['task_description']=item.task_description();committee['data']=data;committees.push(committee);});return committees;}
self.hasNoChanges=function(){if(self.affiliation_id()==0){var notempty=0;var required={affiliation_name:self.affiliation_name()}
for(var prop in required){var str="";if(!str.match(self[prop]()))
notempty++;}
ko.utils.arrayForEach(self.committees(),function(committee){var required={committee_name:committee.committee_name(),from_month:committee.from_month(),from_year:committee.from_year(),to_month:committee.to_month(),to_year:committee.to_year(),to_present:committee.to_present(),task_description:committee.task_description()}
for(var prop in required){var str="";var b=required[prop];var match=str===b||undefined===b;if(!match){console.log(prop);if(!(prop==="to_present")){notempty++;}else{if(b)
notempty+=1;}}}});return notempty==0;}
for(var prop in self.old_data){var a=self.old_data[prop];var b=self[prop]();var match=a===b;if(!match)
return false;}
if(self.old_committees.length!=self.committees().length)
return false;else{var bool=true;ko.utils.arrayForEach(self.committees(),function(committee,index){var required={committee_name:committee.committee_name(),from_month:committee.from_month(),from_year:committee.from_year(),to_month:committee.to_month(),to_year:committee.to_year(),to_present:committee.to_present(),task_description:committee.task_description()}
for(var prop in required){var a=required[prop];var b=self.old_committees[index][prop];var match=a===b;if(!match){bool=false;return bool;}}});return bool;}
return true;}
ko.mapping.fromJS(data,mapping,self);}
var CommitteeModel=function(data,parent){var self=this;self.parent=parent;self.committee_id=ko.observable("");self.committee_name=ko.observable("");self.from_date=ko.observable("");self.from_month=ko.observable("");self.from_year=ko.observable("");self.to_month=ko.observable("");self.to_year=ko.observable("");self.task_description=ko.observable("");self.to_present=ko.observable(false);self.setToPresent=function(){if(self.to_present())
self.to_present(false);else
self.to_present(true);return true;}
self.remove=function(){if(self.parent.committees().length>1)
if(self.committee_id())
self.parent.to_delete_committees.push(self.committee_id());self.parent.committees.remove(self);}
self.getMainFields=function(){var required={committee_name:self.committee_name(),from_month:self.from_month(),from_year:self.from_year(),to_month:self.to_month(),to_year:self.to_year(),task_description:self.task_description(),to_present:self.to_present()}
return required;}
self.validate=function($affiliation,index){var $committeegroup=$affiliation.find('.committee-group:eq('+index+')');var failed=0;var required={committee_name:self.committee_name(),from_month:self.from_month(),from_year:self.from_year(),task_description:self.task_description()}
for(var prop in required){$field=$committeegroup.find("input[name*='"+prop+"']");if($field.length==0)
$field=$committeegroup.find("select[name*='"+prop+"']");if($field.length==0)
$field=$committeegroup.find("textarea[name*='"+prop+"']");if($field.length==0){console.dir("missing: "+prop);}else{if(!self.parent.parent.validate($field,1))
failed+=1;}};return failed;}
ko.mapping.fromJS(data,mapping,self);}
var offsetToScroll="";var editor=$("div#grid-editor");var rules={"default":/^[ñA-Za-z0-9 \-\.']+$/i,"student_number":/^[0-9]{9}$/,"first_name":/^[ñA-Za-z0-9 \-\.']+$/i,"last_name":/^[ñA-Za-z0-9 \-\.']+$/i,"mobile_number":/^[0-9]{11}$/,"email_address":/^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,4})$/i,"address":/^(?!\s*$).+/,"year":/^[12][0-9]{3}$/}
var environ=window.location.host;function getAjaxUrl(){if(environ==="localhost"){var baseurl=window.location.protocol+"//"+window.location.host+"/"+"resumebox/resume_editor/";}else{var baseurl=window.location.protocol+"//"+window.location.host+"/"+"resume_editor/";}
return baseurl;}
var errormessages={"student_number":"Student number must be 9 digits without dash.","first_name":"First name can contain alphabet characters, spaces or dashes only.","last_name":"Last name can contain alphabet characters, spaces or dashes only.","mobile_number":"Mobile number must be 11 digits.","email_address":"Email address must be valid.","default":"must be valid"}
var required={"default":"Required.","student_number":"Please enter your student number.","first_name":"Please enter your first name.","last_name":"Please enter your last name.","email_address":"Please enter your email address.","mobile_number":"Please enter your mobile number.","address":"Please enter your address.","degree_program":"Please choose a degree program."}
var mapping={'recognitions':{create:function(options){return new RecognitionModel(options.data,options.parent);}},'work_descriptions':{create:function(options){return new WorkDescriptionModel(options.data,options.parent);}},'committees':{create:function(options){return new CommitteeModel(options.data,options.parent);}}}
var SkillsModel=function(data,parent){var self=this;self.parent=parent;self.skills=ko.observable("");self.old_skills="";self.isEditing=ko.observable(false);self.edit_skills=ko.computed(function(){return self.skills().replace(/<br\s*[\/]?>/gi,"\n");},self);self.text_skills=ko.computed(function(){return self.skills().replace(/\r\n|\r|\n/g,"<br/>");},self);self.edit=function(item,event){$(event.target).parents('div.skills-group').find('textarea').autosize({resizeDelay:100,append:false});self.isEditing(true);self.parent.isEditing(true);self.old_skills=self.skills();self.skills(self.edit_skills());}
self.cancel=function(){self.isEditing(false);self.parent.isEditing(false);self.skills(self.old_skills);self.old_skills="";}
self.save=function(){var $skills=$('div#skills .skills-group').first();var data={student_number:self.parent.student_number(),section:"skills",skills:self.skills()};if(environ==="localhost"){var baseurl=window.location.protocol+"//"+window.location.host+"/"+"resumebox/resume_editor/save_skills/";}else{var baseurl=window.location.protocol+"//"+window.location.host+"/"+"resume_editor/save_skills/";}
$.ajax({url:baseurl,type:"POST",data:data,beforeSend:function(){$('body').append('<div class="div-loading"></div>');},success:function(response){$(".div-loading").remove();self.isEditing(false);self.parent.isEditing(false);}})}
ko.mapping.fromJS(data,{},self);}
var ResumeManagerModel=function(){var self=this;jQuery.fn.scrollTo=function(elem,speed){$(this).animate({scrollTop:$(this).scrollTop()-$(this).offset().top+elem.offset().top-150},speed==undefined?400:speed);return this;};self.months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];self.student_number=ko.observable(student_number);self.personal_info=new PersonalInfoModel(personal_info,self);self.skills=new SkillsModel({},self);self.skills.skills(skills);self.fullname=ko.computed(function(){return self.personal_info.first_name()+" "+self.personal_info.last_name();});self.availableStudentType=ko.observableArray(["Undergraduate","Graduate"]);self.isGraduating=ko.observable(false);self.availableUndergraduateCourses=ko.observable(["Bachelor of Science in Chemical Engineering","Bachelor of Science in Civil Engineering","Bachelor of Science in Computer Science","Bachelor of Science in Computer Engineering","Bachelor of Science in Electrical Engineering","Bachelor of Science in Electronics & Communications Engineering","Bachelor of Science in Geodetic Engineering","Bachelor of Science in Industrial Engineering","Bachelor of Science in Mechanical Engineering","Bachelor of Science in Materials Engineering","Bachelor of Science in Metallurgical Engineering","Bachelor of Science in Mining Engineering"])
self.isEditing=ko.observable(false);self.isEditing.subscribe(function(){ko.bindingHandlers.sortable.isEnabled(!self.isEditing());},self);self.student_type=ko.observable(student_type);self.education_graduate=new EducationModel(education_graduate,self);self.education_undergraduate=new EducationModel(education_undergraduate,self);self.education_highschool=new EducationModel(education_highschool,self);self.education=ko.observableArray([]);if(self.student_type()==="Graduate"){self.education.push(self.education_graduate);}
self.education.push(self.education_undergraduate,self.education_highschool);var mapped_work_experience=ko.utils.arrayMap(work_experience,function(data){return new WorkExpModel(data,self);});self.workExp=ko.observableArray(mapped_work_experience);var mapped_affiliations=ko.utils.arrayMap(affiliations,function(data){return new AffiliationModel(data,self);});self.affiliations=ko.observableArray(mapped_affiliations);self.application_type=ko.observable("");self.hasWorkExp=function(){if(self.workExp().length>0){return true;}else
return false;}
self.hasAffiliation=function(){if(self.affiliations().length>0){return true;}else
return false;}
self.addWorkExp=function(){var count=self.workExp().length;if(count<10&&!self.isEditing()){var work=new WorkExpModel({work_id:0},self);self.workExp.push(work);work.edit(work);self.isEditing(true);$('[data-toggle="tooltip"]').tooltip();editor.scroll();editor.scrollTo($('div.work-experience-group').last());}}
self.addAffiliation=function(){var count=self.affiliations().length;if(count<10&&!self.isEditing()){self.affiliations.push(new AffiliationModel({affiliation_id:0,isEditing:true,order:count},self));self.isEditing(true);editor.scroll();editor.scrollTo($('div.affiliation-group').last());}}
self.addAffiliationTitle=ko.pureComputed(function(){return self.isEditing()?"Disabled on editing mode.":"Create new affiliation";},self);self.isUndergraduate=function(){return(self.student_type()=="Undergraduate")?true:false;}
self.isPersonalInfo=ko.observable(true);self.isEducation=ko.observable(false);self.isWorkExp=ko.observable(false);self.isExtraCurr=ko.observable(false);self.isSubmit=ko.observable(false);self.isPreview=ko.observable(true);self.isSkills=ko.observable(false);self.isConfirmed=ko.observable(false);self.showPersonalInfo=function(){if(self.isPersonalInfo())
return;if(self.isWorkExp()||self.isExtraCurr()){if(!self.cancelEmptyItems()){return false;}}
self.isPersonalInfo(true);self.isEducation(false);self.isWorkExp(false);self.isExtraCurr(false);self.isSkills(false);self.isSubmit(false);$(window).scrollTop(0);}
self.showEducation=function(){if(self.isEducation())
return;if(!self.cancelEmptyItems()){return false;}
self.isPersonalInfo(false);self.isEducation(true);self.isWorkExp(false);self.isExtraCurr(false);self.isSkills(false);self.isSubmit(false);$(window).scrollTop(0);}
self.showWorkExp=function(){if(self.isWorkExp())
return;if(!self.cancelEmptyItems()){return false;}
self.isPersonalInfo(false);self.isEducation(false);self.isWorkExp(true);self.isExtraCurr(false);self.isSkills(false);self.isSubmit(false);$(window).scrollTop(0);}
self.showExtraCurr=function(){if(self.isExtraCurr())
return;if(!self.cancelEmptyItems()){return false;}
self.isPersonalInfo(false);self.isEducation(false);self.isWorkExp(false);self.isExtraCurr(true);self.isSkills(false);self.isSubmit(false);$(window).scrollTop(0);}
self.showSkills=function(){if(self.isSkills())
return;if(!self.cancelEmptyItems()){return false;}
self.isPersonalInfo(false);self.isEducation(false);self.isWorkExp(false);self.isExtraCurr(false);self.isSkills(true);self.isSubmit(false);$(window).scrollTop(0);}
self.showSubmit=function(){if(self.isSubmit())
return;if(!self.cancelEmptyItems()){return false;}
self.isPersonalInfo(false);self.isEducation(false);self.isWorkExp(false);self.isExtraCurr(false);self.isSkills(false);self.isSubmit(true);$(window).scrollTop(0);}
self.isCertified=ko.observable(false);self.submitResume=function(item,event){if(self.validateSubmit()){if(!self.isUndergraduate()){self.application_type(1);}
if(!self.isCertified()||!self.application_type()){if(!self.isCertified()){$(".terms").addClass("terms-danger");setTimeout(function(){$(".terms").removeClass("terms-danger");},1200);}
if(!self.application_type()){$(".application-type").addClass("terms-danger");setTimeout(function(){$(".application-type").removeClass("terms-danger");},1200);}
var file=$('input#userfile')[0].files[0];if(file!=undefined){if(file.name.length>0)
if(file.size>5000000){alert("File is too big");}else if(file.type!='application/pdf'){alert("File is not a pdf file");}}}else{var form=new FormData(document.getElementById('resume-submit'));var baseurl=getAjaxUrl()+"submit_resume";form.append('student_number',self.student_number());if(!(currentscheme.color()==="yellow"))
form.append('colorscheme',currentscheme.color());$.ajax({type:'POST',url:baseurl,data:form,beforeSend:function(){$('body').append('<div class="div-loading"></div>');},processData:false,contentType:false,success:function(response){if(response){$(".div-loading").remove();$("#submit-success").fadeIn("fast");}else{$(".div-loading").remove();$("#submit-success").fadeIn("fast");}},error:function(x,t,h){$(".div-loading").remove();$("#submit-error").fadeIn("fast");},complete:function(){$('form#resume-submit').find('input').removeAttr('checked');$('form#resume-submit').find('userfile').val('');}});return false;}}}
self.validateOnBlur=function(item,event){var $target=$(event.target);if(self.validate($target)){var $success_icon=$('<span class="fa fa-check success-check" style="display:none"></span>');$target.parent('div').append($success_icon).find('.success-check').fadeIn();setTimeout(function(){$target.parent().find('.success-check').fadeOut();},1500);var field_name=$target.attr("name");var value=$target.val().trim();var data="";var valid=0;if(self.isEducation()){if(field_name.match("student_type")){value=self.student_type();valid=1;if(value.match("Undergraduate")){self.education.remove(function(item){return item['type']()==="graduate"});value=1;}
else{self.education.unshift(self.education_graduate);value=2;}
data={student_number:self.student_number(),section:'personal_info',field_name:field_name,value:value}}}
if(valid){if(environ==="localhost"){var baseurl=window.location.protocol+"//"+window.location.host+"/"+"resumebox/resume_editor/save_item/";}else{var baseurl=window.location.protocol+"//"+window.location.host+"/"+"resume_editor/save_item/";}
$.ajax({type:"POST",url:baseurl,data:data,beforeSend:function(){$('body').append('<div class="div-loading"></div>');},success:function(response){if(!response)
return;response=JSON.parse(response);if(field_name=="student_type"&&value==1){ko.utils.arrayForEach(self.education(),function(item){if(item['type']()==="undergraduate"){item.school_name("University of the Philippines Diliman");}});}
if(field_name=="student_type"&&value==2){ko.utils.arrayForEach(self.education(),function(item){if(item['type']()==="undergraduate"){item.degree_program("");}});}
if(response['code']==404)
window.location.replace(response['url']);else{var $success_icon=$('<span class="fa fa-check success-check" style="display:none"></span>');$target.parent('div').append($success_icon).find('.success-check').fadeIn();setTimeout(function(){$target.parent().find('.success-check').fadeOut();},1500);}},complete:function(){$('div.div-loading').remove();}});}}
$('.work-experience-group, .affiliation-group').removeClass('group-highlight');}
self.validate=function($target,allrequired){var allrequired=(allrequired===undefined)?0:allrequired;var name=$target.attr("name");var input=$target.val();var $p=$target.next('p');if(input==""){if(!allrequired){if($target.attr("data-notrequired")!=undefined)
return true;}
$target.addClass('danger');if(required[name]!=undefined){if($p.length==0)
$target.after('<p class="error">'+required[name]+'</p>');}else{if($p.length==0)
$target.after('<p class="error">'+required['default']+'</p>');}
return false;}
else{if(name!=""&&name!=undefined){if(rules[name]!=undefined)
if(!input.match(rules[name])){$target.addClass("danger");if(errormessages[name]!=undefined){if($p.length==0)
$target.after('<p class="error">'+errormessages[name]+'</p>');}else{var errormessage=(name.charAt(0).toUpperCase()+name.slice(1)).replace(/_/g," ")+" "+errormessages['default'];if($p.length==0)
$target.after('<p class="error">'+errormessage+'</p>');}
return false;}
if(name.indexOf("year")>-1){name='year';if(!input.match(rules[name])){$target.addClass("danger");if(errormessages[name]!=undefined){if($p.length==0)
$target.after('<p style="width:'+$target.width()+'px" class="error">'+errormessages[name]+'</p>');}else{var errormessage=(name.charAt(0).toUpperCase()+name.slice(1)).replace(/_/g," ")+" "+errormessages['default'];if($p.length==0)
$target.after('<p style="width:'+$target.width()+'px" class="error">'+errormessage+'.</p>');}
return false;}}}}
return true;}
self.validateSubmit=function(){var failed=0;$('input,textarea,select').removeClass('danger');$('p.error').remove();if(!self.personal_info.validateFields()){return false;}
failed=0;prop={'undergraduate:':{0:'graduation_month',1:'graduation_year',2:'degree_program'},'highschool:':{0:'graduation_month',1:'graduation_year',2:'school_name'}}
if(self.student_type()==="Graduate"){prop['graduate:']={0:'graduation_month',1:'graduation_year',2:'degree_program'};prop['undergraduate:'][3]="school_name";}
var count=0;for(var i in prop){for(var j in prop[i]){$field=$("#education").find('input[name~="'+i+prop[i][j]+'"], textarea[name~="'+i+prop[i][j]+'"], select[name~="'+i+prop[i][j]+'"]');if($field.length==0)
window.location.reload();else{if(!self.validate($field,1)){failed+=1;self.education()[count].edit(self.education()[count]);}}}
count+=1;}
if(failed){self.showEducation();setTimeout(function(){self.validateAll();},100);return false;}
return failed==0;}
self.validateAll=function(){var failed=0;$('input,textarea,select').removeClass('danger');$('p.error').remove();if(!self.personal_info.validateFields()){self.showPersonalInfo();}
else if(self.isEducation()){$('div#education').find('input,textarea,select').each(function(){if(!self.validate($(this)))
failed+=1;});}
if(failed){editor.scroll();editor.scrollTo($('.danger').first());}else{self.cancelEmptyItems();}
return failed==0;}
self.cancelEmptyItems=function(){var failed=0;if(self.isPersonalInfo()){if(self.personal_info.isEditing()){if(self.personal_info.hasNoChanges()){self.personal_info.cancel();}else{self.personal_info.setAlerts(".alert-info.alert-changes");return false;}}}else if(self.isEducation()){ko.utils.arrayForEach(self.education(),function(item,index){if(item.isEditing()){if(item.hasNoChanges())
{item.cancel(item);}else{var $mask=$('#education .alert-mask:eq('+index+')');var $alert=$('#education .alert-changes:eq('+index+')');$mask.on('click',function(){$mask.removeClass('alert-notify');$alert.removeClass('alert-notify');});editor.scroll();editor.scrollTo($('#education .work-actions:eq('+index+')'));failed+=1;setTimeout(function(){$mask.addClass('alert-notify');$alert.addClass('alert-notify');},100);setTimeout(function(){$mask.removeClass('alert-notify');$alert.removeClass('alert-notify');},2500);return false;}}});}
else if(self.isWorkExp()){ko.utils.arrayForEach(self.workExp(),function(item,index){if(item.isEditing()){if(item.hasNoChanges())
{item.cancel(item);}else{var $mask=$('#workexp .alert-mask:eq('+index+')');var $alert=$('#workexp .alert-changes:eq('+index+')');$mask.on('click',function(){$mask.removeClass('alert-notify');$alert.removeClass('alert-notify');});editor.scroll();editor.scrollTo($('#workexp .work-actions:eq('+index+')'));failed+=1;setTimeout(function(){$mask.addClass('alert-notify');$alert.addClass('alert-notify');},100);setTimeout(function(){$mask.removeClass('alert-notify');$alert.removeClass('alert-notify');},2500);return false;}}});}else if(self.isExtraCurr()){ko.utils.arrayForEach(self.affiliations(),function(item,index){if(item.isEditing()){if(item.hasNoChanges())
{item.cancel(item);}else{var $mask=$('#extra-curricular .alert-mask:eq('+index+')');var $alert=$('#extra-curricular .alert-changes:eq('+index+')');$mask.on('click',function(){$mask.removeClass('alert-notify');$alert.removeClass('alert-notify');});editor.scroll();editor.scrollTo($('#extra-curricular .work-actions:eq('+index+')'));failed+=1;setTimeout(function(){$mask.addClass('alert-notify');$alert.addClass('alert-notify');},100);setTimeout(function(){$mask.removeClass('alert-notify');$alert.removeClass('alert-notify');},2500);return false;}}});if(self.isOrderChanged())
self.cancelOrder();}else if(self.isSkills()){if(self.skills.isEditing())
self.skills.cancel();}
return failed==0;}
self.resetInput=function(item,event){var $target=$(event.target);$target.removeClass("danger");$target.next('p').fadeOut(100,function(){$(this).remove();});if(self.isWorkExp()){$target.parents('.work-experience-group').addClass('group-highlight');}
if(self.isExtraCurr()){$target.parents('.affiliation-group').addClass('group-highlight');}}
ko.bindingHandlers.fadeVisible={init:function(element,valueAccessor){var value=valueAccessor();$(element).toggle(ko.unwrap(value));},update:function(element,valueAccessor){var value=valueAccessor();ko.unwrap(value)?$(element).delay(50).fadeIn(400):$(element).fadeOut(50);}};var old_affiliations=[];self.isOrderChanged=ko.observable(false);self.saveOrder=function(){var affiliations=[];if(self.isExtraCurr()){ko.utils.arrayForEach(self.affiliations(),function(x){affiliations.push({affiliation_id:x.affiliation_id(),order:x.order()});});$.ajax({url:getAjaxUrl()+"save_affiliations_order",type:"POST",data:{section:"affiliations",student_number:self.student_number(),affiliations:affiliations},beforeSend:function(){$('body').append('<div class="div-loading"></div>');},success:function(response){$(".div-loading").remove();self.isOrderChanged(false);old_affiliations=[];}});}}
self.cancelOrder=function(){if(self.isExtraCurr()){ko.utils.arrayForEach(self.affiliations(),function(x){x.order(old_affiliations[x.affiliation_id()]);});self.isOrderChanged(false);self.affiliations().sort(function(l,r){return l.order()>r.order()?1:-1});self.affiliations.valueHasMutated();old_affiliations=[];}}
ko.bindingHandlers.sortable.beforeMove=function(arg){var i=0;if(self.isExtraCurr()){if(old_affiliations.length==0)
ko.utils.arrayForEach(arg.sourceParent(),function(x){old_affiliations[x.affiliation_id()]=i;i++;});}}
ko.bindingHandlers.sortable.options={placeholder:"sortable-state-highlight",start:function(e,ui){ui.placeholder.height(ui.helper.outerHeight());},containment:"#grid-editor"}
ko.bindingHandlers.sortable.isEnabled=ko.observable(true);ko.bindingHandlers.sortable.afterMove=function(arg){var i=0;if(self.isExtraCurr()){ko.utils.arrayForEach(arg.targetParent(),function(x){x.order(i);i++;});self.isOrderChanged(true);}}
var colorSchemeModel=function(data,parent){var self=this;self.color=ko.observable("");self.selected=ko.observable(false);self.setColorScheme=function(){$('.label-col,.subname').removeClass(currentscheme.color()+"-scheme");$('.label-col,.subname').addClass(self.color()+"-scheme");currentscheme=self;return true;}
ko.mapping.fromJS(data,{},self);}
var currentscheme=new colorSchemeModel({color:"yellow",selected:true});self.color_palette=ko.observableArray([currentscheme,new colorSchemeModel({color:"plum",selected:false}),new colorSchemeModel({color:"orange",selected:false}),new colorSchemeModel({color:"blue",selected:false})]);}
